#!/usr/bin/env bash
#SBATCH -J featureCounts_mm39
#SBATCH -c 8
#SBATCH --mem=16G
#SBATCH --time=04:00:00
#SBATCH --partition=pibu_el8
#SBATCH -o counts/featureCounts_%j.out
#SBATCH -e counts/featureCounts_%j.err

set -euo pipefail

module load Subread

PROJ=/data/users/abarbosa/projects/rna-seq-lung
ALIGN=$PROJ/align
REFS=$PROJ/refs
OUT=$PROJ/counts

GTF=$REFS/Mus_musculus.GRCm39.113.gtf

mkdir -p "$OUT"

featureCounts \
  -T 8 \
  -p \
  -s 0 \
  -a "$GTF" \
  -o "$OUT/gene_counts.txt" \
  $ALIGN/*.bam

echo ">> FeatureCounts completed. File saved in $OUT/gene_counts.txt"

# To run the job:
# sbatch scripts/03_featureCounts_mm39.slurm
# This script runs featureCounts to count gene-aligned reads
# using the BAM files generated by HISAT2.

# The results are saved in counts/gene_counts.txt
# Ensure that the BAM files are present in the align/ directory
# and that the GTF file is correctly located in the refs/ directory.

# Monitor the execution with:
# squeue -u $USER -n featureCounts_mm39

########
#####
# IMPORTANT:

# The -s 0 parameter indicates that the data is not strand-specific.

# If the data is strand-specific, adjust this parameter to -s 1 or -2 as needed.

# Consult the featureCounts documentation for more details.

######
# After completion, check the output file to ensure the counts were generated correctly.

# You can use tools like R or Python to analyze the count data later.